name: CI

on:
  workflow_dispatch:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  proof-runner-gate:
    name: Proof Runner Gate
    runs-on: windows-latest
    env:
      DATABASE_URL: "postgresql://ci:ci@localhost:5432/ci"
    defaults:
      run:
        shell: pwsh
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 'lts/*'
          cache: 'npm'
          cache-dependency-path: api/package-lock.json

      - name: Prepare expected repo path
        run: |
          New-Item -ItemType Directory -Path 'C:\Users\vitor\Dev' -Force | Out-Null
          if (Test-Path 'C:\Users\vitor\Dev\factory') {
            Remove-Item -Path 'C:\Users\vitor\Dev\factory' -Recurse -Force
          }
          git clone --no-hardlinks --depth 1 "$env:GITHUB_WORKSPACE" 'C:\Users\vitor\Dev\factory'
          Set-Location 'C:\Users\vitor\Dev\factory'
          git checkout "$env:GITHUB_SHA"

      - name: Install API dependencies
        working-directory: C:\Users\vitor\Dev\factory
        run: npm -C api ci

      - name: Verify repo guard
        working-directory: C:\Users\vitor\Dev\factory
        run: pwsh -File .\scripts\ensure-repo.ps1

      - name: Run proof runner
        working-directory: C:\Users\vitor\Dev\factory
        run: pwsh -File .\scripts\proof-runner.ps1

      - name: Assert proof artifact exists
        working-directory: C:\Users\vitor\Dev\factory
        run: |
          $latest = Get-ChildItem -Path .\proof\runs -Filter 'proof-*.txt' -File | Sort-Object LastWriteTime -Descending | Select-Object -First 1
          if (-not $latest) {
            Write-Error 'No proof transcript found under proof/runs.'
            exit 1
          }
          Write-Host "PROOF_FILE=$($latest.FullName)"

  live-smoke:
    name: Live Smoke
    runs-on: ubuntu-latest
    needs: [proof-runner-gate]
    defaults:
      run:
        shell: pwsh
    env:
      API_BASE: ${{ vars.API_BASE != '' && vars.API_BASE || secrets.API_BASE }}
      WEB_URL: ${{ vars.WEB_URL != '' && vars.WEB_URL || secrets.WEB_URL }}
      NETLIFY_SITE_ID: ${{ vars.NETLIFY_SITE_ID != '' && vars.NETLIFY_SITE_ID || secrets.NETLIFY_SITE_ID }}
      NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
    steps:
      - name: Validate required configuration
        run: |
          if ([string]::IsNullOrWhiteSpace($env:API_BASE)) {
            Write-Error "Missing API_BASE. Set GitHub Actions variable 'API_BASE' (Settings -> Secrets and variables -> Actions -> Variables)."
            exit 1
          }
          if ([string]::IsNullOrWhiteSpace($env:WEB_URL)) {
            Write-Error "Missing WEB_URL. Set GitHub Actions variable 'WEB_URL' (Settings -> Secrets and variables -> Actions -> Variables)."
            exit 1
          }
          if ([string]::IsNullOrWhiteSpace($env:NETLIFY_SITE_ID)) {
            Write-Error "Missing NETLIFY_SITE_ID. Set GitHub Actions variable 'NETLIFY_SITE_ID' (Settings -> Secrets and variables -> Actions -> Variables) or secret 'NETLIFY_SITE_ID'."
            exit 1
          }
          if ([string]::IsNullOrWhiteSpace($env:NETLIFY_AUTH_TOKEN)) {
            Write-Error "Missing NETLIFY_AUTH_TOKEN. Set GitHub Actions secret 'NETLIFY_AUTH_TOKEN' (Settings -> Secrets and variables -> Actions -> Secrets)."
            exit 1
          }

      - name: Smoke checks
        run: |
          $apiBase = $env:API_BASE.TrimEnd('/')
          $webUrl = $env:WEB_URL.TrimEnd('/')
          $apiHost = ([uri]$apiBase).Host
          $webHost = ([uri]$webUrl).Host

          $apiRoot = Invoke-WebRequest -Uri "$apiBase/" -Method Get
          Write-Host "API host=$apiHost status=$($apiRoot.StatusCode)"
          if ($apiRoot.StatusCode -ne 200) {
            Write-Error "API root check failed with status $($apiRoot.StatusCode)."
            exit 1
          }

          $dbHealth = Invoke-WebRequest -Uri "$apiBase/db/health" -Method Get
          $dbJson = $dbHealth.Content | ConvertFrom-Json
          Write-Host "API host=$apiHost db-health status=$($dbHealth.StatusCode) ok=$($dbJson.ok)"
          if ($dbHealth.StatusCode -ne 200 -or $dbJson.ok -ne $true) {
            Write-Error "API db/health check failed."
            exit 1
          }

          $webRoot = Invoke-WebRequest -Uri "$webUrl/" -Method Get
          Write-Host "WEB host=$webHost status=$($webRoot.StatusCode)"
          if ($webRoot.StatusCode -ne 200) {
            Write-Error "Web root check failed with status $($webRoot.StatusCode)."
            exit 1
          }

          $headers = @{ Authorization = "Bearer $env:NETLIFY_AUTH_TOKEN" }
          $netlifyEnv = Invoke-RestMethod -Method Get -Uri "https://api.netlify.com/api/v1/sites/$($env:NETLIFY_SITE_ID)/env" -Headers $headers
          $apiUrlEntry = $netlifyEnv | Where-Object { $_.key -eq 'NEXT_PUBLIC_API_URL' } | Select-Object -First 1
          if (-not $apiUrlEntry) {
            Write-Error "Netlify env var NEXT_PUBLIC_API_URL not found for production site settings."
            exit 1
          }

          $netlifyApiBase = $null
          if ($apiUrlEntry.values) {
            $prodValue = $apiUrlEntry.values | Where-Object { $_.context -eq 'production' } | Select-Object -First 1
            if (-not $prodValue) {
              $prodValue = $apiUrlEntry.values | Where-Object { $_.context -eq 'all' } | Select-Object -First 1
            }
            if ($prodValue) {
              $netlifyApiBase = $prodValue.value
            }
          }
          if (-not $netlifyApiBase -and $apiUrlEntry.value) {
            $netlifyApiBase = $apiUrlEntry.value
          }
          if ([string]::IsNullOrWhiteSpace($netlifyApiBase)) {
            Write-Error "Unable to resolve Netlify production NEXT_PUBLIC_API_URL value."
            exit 1
          }

          $netlifyApiHost = ([uri]$netlifyApiBase).Host
          $matches = $netlifyApiBase -ceq $env:API_BASE
          Write-Host "Netlify host=$netlifyApiHost alignment=$matches"
          if (-not $matches) {
            Write-Error "Netlify production NEXT_PUBLIC_API_URL does not exactly match API_BASE (trailing slash mismatch included)."
            exit 1
          }

  web:
    name: Web
    runs-on: ubuntu-latest
    needs: [proof-runner-gate, live-smoke]
    defaults:
      run:
        working-directory: web
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 'lts/*'
          cache: 'npm'
          cache-dependency-path: web/package-lock.json
      
      - name: Install dependencies
        run: npm ci
      
      - name: Lint
        run: npm run lint
      
      - name: Build
        run: npm run build

  api:
    name: API
    runs-on: ubuntu-latest
    needs: [proof-runner-gate, live-smoke]
    defaults:
      run:
        working-directory: api
    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_USER: ci
          POSTGRES_PASSWORD: ci
          POSTGRES_DB: ci
        ports:
          - 5432:5432
        options: >-
          --health-cmd "pg_isready -U ci -d ci"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    env:
      DATABASE_URL: "postgresql://ci:ci@localhost:5432/ci"
    steps:
      - uses: actions/checkout@v4

      - name: Wait for Postgres
        shell: bash
        run: |
          for i in {1..30}; do
            if (echo > /dev/tcp/127.0.0.1/5432) >/dev/null 2>&1; then
              echo "Postgres is ready"
              exit 0
            fi
            echo "Waiting for Postgres... ($i/30)"
            sleep 1
          done
          echo "Postgres did not become ready in time"
          exit 1

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 'lts/*'
          cache: 'npm'
          cache-dependency-path: api/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Lint
        run: npm run lint

      - name: Build
        run: npm run build

  factory:
    name: Factory Checks
    runs-on: ubuntu-latest
    needs: [proof-runner-gate, live-smoke]
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 'lts/*'
      
      - name: Validate v1 spec
        run: node tools/validate-spec.mjs tools/specs/feature-sample.json
      
      - name: Validate v2 spec
        run: node tools/validate-spec.mjs tools/specs/feature-sample.v2.json
      
      - name: Generator v1 dry-run
        run: node tools/generate-mobile-feature.mjs --spec tools/specs/feature-sample.json --out mobile --dry-run
      
      - name: Generator v2 dry-run
        run: node tools/generate-mobile-feature.mjs --spec tools/specs/feature-sample.v2.json --out mobile --dry-run
      
      - name: Smoke test (non-mutating)
        run: pwsh -File scripts/smoke-factory.ps1

  production-build:
    name: Production Build
    runs-on: ubuntu-latest
    needs: [proof-runner-gate, live-smoke]
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 'lts/*'

      - name: Validate Production Env Docs
        run: pwsh ./scripts/validate-env-prod.ps1
      
      - name: API Production Build
        env:
          DATABASE_URL: "postgresql://ci:ci@localhost:5432/ci"
        run: pwsh -File scripts/build-api-prod.ps1
      
      - name: Web Production Build
        run: pwsh -File scripts/build-web-prod.ps1
      
      - name: Mobile Production Validation
        run: pwsh -File scripts/validate-mobile-prod.ps1

  security:
    name: Security Hardening
    runs-on: ubuntu-latest
    needs: [proof-runner-gate, live-smoke]
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 'lts/*'
      
      - name: Security baseline scan (CI strict)
        run: pwsh -File scripts/security-scan.ps1 -CiStrict

  release:
    name: Release Packaging
    needs: [production-build, security]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 'lts/*'
      
      - name: Release gate checks
        run: pwsh -File scripts/release-check.ps1

  deploy-readiness:
    name: Deployment Readiness
    runs-on: ubuntu-latest
    needs: [proof-runner-gate, live-smoke]
    steps:
      - uses: actions/checkout@v4
      
      - name: Post-deploy smoke test (LocalOnly)
        shell: pwsh
        run: pwsh -File scripts/post-deploy-smoke.ps1 -ApiUrl https://example.invalid -WebUrl https://example.invalid -LocalOnly

  ops-monitoring:
    name: Ops Monitoring
    runs-on: ubuntu-latest
    needs: [proof-runner-gate, live-smoke]
    steps:
      - uses: actions/checkout@v4

      - name: Step M proof harness (LocalOnly)
        shell: pwsh
        run: pwsh -File scripts/proof-step-m.ps1 -LocalOnly

  ops-incident:
    name: Ops Incident Drill
    runs-on: ubuntu-latest
    needs: [proof-runner-gate, live-smoke]
    steps:
      - uses: actions/checkout@v4

      - name: Step N proof harness (LocalOnly)
        shell: pwsh
        run: pwsh -File scripts/proof-step-n.ps1 -LocalOnly

  ops-live-proof-localonly:
    runs-on: windows-latest
    needs: [proof-runner-gate, live-smoke]
    steps:
      - uses: actions/checkout@v4
      - shell: pwsh
        run: ./scripts/proof-step-o.ps1 -LocalOnly
