name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  proof-runner-gate:
    name: Proof Runner Gate
    runs-on: windows-latest
    defaults:
      run:
        shell: pwsh
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 'lts/*'
          cache: 'npm'
          cache-dependency-path: api/package-lock.json

      - name: Prepare expected repo path
        run: |
          New-Item -ItemType Directory -Path 'C:\Users\vitor\Dev' -Force | Out-Null
          if (-not (Test-Path 'C:\Users\vitor\Dev\factory')) {
            New-Item -ItemType Junction -Path 'C:\Users\vitor\Dev\factory' -Target $env:GITHUB_WORKSPACE | Out-Null
          }

      - name: Install API dependencies
        working-directory: C:\Users\vitor\Dev\factory
        run: npm -C api ci

      - name: Verify repo guard
        working-directory: C:\Users\vitor\Dev\factory
        run: pwsh -File .\scripts\ensure-repo.ps1

      - name: Run proof runner
        working-directory: C:\Users\vitor\Dev\factory
        run: pwsh -File .\scripts\proof-runner.ps1

      - name: Assert proof artifact exists
        working-directory: C:\Users\vitor\Dev\factory
        run: |
          $latest = Get-ChildItem -Path .\proof\runs -Filter 'proof-*.txt' -File | Sort-Object LastWriteTime -Descending | Select-Object -First 1
          if (-not $latest) {
            Write-Error 'No proof transcript found under proof/runs.'
            exit 1
          }
          Write-Host "PROOF_FILE=$($latest.FullName)"

  web:
    name: Web
    runs-on: ubuntu-latest
    needs: [proof-runner-gate]
    defaults:
      run:
        working-directory: web
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 'lts/*'
          cache: 'npm'
          cache-dependency-path: web/package-lock.json
      
      - name: Install dependencies
        run: npm ci
      
      - name: Lint
        run: npm run lint
      
      - name: Build
        run: npm run build

  api:
    name: API
    runs-on: ubuntu-latest
    needs: [proof-runner-gate]
    defaults:
      run:
        working-directory: api
    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_USER: ci
          POSTGRES_PASSWORD: ci
          POSTGRES_DB: ci
        ports:
          - 5432:5432
        options: >-
          --health-cmd "pg_isready -U ci -d ci"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    env:
      DATABASE_URL: "postgresql://ci:ci@localhost:5432/ci"
    steps:
      - uses: actions/checkout@v4

      - name: Wait for Postgres
        shell: bash
        run: |
          for i in {1..30}; do
            if (echo > /dev/tcp/127.0.0.1/5432) >/dev/null 2>&1; then
              echo "Postgres is ready"
              exit 0
            fi
            echo "Waiting for Postgres... ($i/30)"
            sleep 1
          done
          echo "Postgres did not become ready in time"
          exit 1

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 'lts/*'
          cache: 'npm'
          cache-dependency-path: api/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Lint
        run: npm run lint

      - name: Build
        run: npm run build

  factory:
    name: Factory Checks
    runs-on: ubuntu-latest
    needs: [proof-runner-gate]
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 'lts/*'
      
      - name: Validate v1 spec
        run: node tools/validate-spec.mjs tools/specs/feature-sample.json
      
      - name: Validate v2 spec
        run: node tools/validate-spec.mjs tools/specs/feature-sample.v2.json
      
      - name: Generator v1 dry-run
        run: node tools/generate-mobile-feature.mjs --spec tools/specs/feature-sample.json --out mobile --dry-run
      
      - name: Generator v2 dry-run
        run: node tools/generate-mobile-feature.mjs --spec tools/specs/feature-sample.v2.json --out mobile --dry-run
      
      - name: Smoke test (non-mutating)
        run: pwsh -File scripts/smoke-factory.ps1

  production-build:
    name: Production Build
    runs-on: ubuntu-latest
    needs: [proof-runner-gate]
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 'lts/*'

      - name: Validate Production Env Docs
        run: pwsh ./scripts/validate-env-prod.ps1
      
      - name: API Production Build
        env:
          DATABASE_URL: "postgresql://ci:ci@localhost:5432/ci"
        run: pwsh -File scripts/build-api-prod.ps1
      
      - name: Web Production Build
        run: pwsh -File scripts/build-web-prod.ps1
      
      - name: Mobile Production Validation
        run: pwsh -File scripts/validate-mobile-prod.ps1

  security:
    name: Security Hardening
    runs-on: ubuntu-latest
    needs: [proof-runner-gate]
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 'lts/*'
      
      - name: Security baseline scan (CI strict)
        run: pwsh -File scripts/security-scan.ps1 -CiStrict

  release:
    name: Release Packaging
    needs: [production-build, security]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 'lts/*'
      
      - name: Release gate checks
        run: pwsh -File scripts/release-check.ps1

  deploy-readiness:
    name: Deployment Readiness
    runs-on: ubuntu-latest
    needs: [proof-runner-gate]
    steps:
      - uses: actions/checkout@v4
      
      - name: Post-deploy smoke test (LocalOnly)
        shell: pwsh
        run: pwsh -File scripts/post-deploy-smoke.ps1 -ApiUrl https://example.invalid -WebUrl https://example.invalid -LocalOnly

  ops-monitoring:
    name: Ops Monitoring
    runs-on: ubuntu-latest
    needs: [proof-runner-gate]
    steps:
      - uses: actions/checkout@v4

      - name: Step M proof harness (LocalOnly)
        shell: pwsh
        run: pwsh -File scripts/proof-step-m.ps1 -LocalOnly

  ops-incident:
    name: Ops Incident Drill
    runs-on: ubuntu-latest
    needs: [proof-runner-gate]
    steps:
      - uses: actions/checkout@v4

      - name: Step N proof harness (LocalOnly)
        shell: pwsh
        run: pwsh -File scripts/proof-step-n.ps1 -LocalOnly

  ops-live-proof-localonly:
    runs-on: windows-latest
    needs: [proof-runner-gate]
    steps:
      - uses: actions/checkout@v4
      - shell: pwsh
        run: ./scripts/proof-step-o.ps1 -LocalOnly
