name: Uptime Prod

on:
  workflow_dispatch:
  schedule:
    - cron: '*/15 * * * *'

jobs:
  uptime-check:
    name: uptime-check
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash
    steps:
      - name: Check production API endpoints
        run: |
          set -euo pipefail

          check_endpoint() {
            local endpoint="$1"
            local expected_status="$2"

            status_code=$(curl -s -o response.txt -w "%{http_code}" "$endpoint")
            body_snippet=$(head -c 200 response.txt | tr '\n' ' ')

            echo "Endpoint: $endpoint"
            echo "Status: $status_code"
            echo "Body (first 200 chars): $body_snippet"

            if [ "$status_code" != "$expected_status" ]; then
              echo "Expected HTTP $expected_status but got $status_code"
              exit 1
            fi
          }

          check_endpoint "https://factory-production-production.up.railway.app/db/health" "200"
          check_endpoint "https://factory-production-production.up.railway.app/" "200"
          check_endpoint "https://factory-production-production.up.railway.app/debug-sentry" "500"

      - name: Print runbook reference
        if: always()
        run: |
          echo "RUNBOOK: docs/ops/RUNBOOK.md"
          echo "If this workflow failed, see Alert Triage Map section."
          echo "Check docs/ops/ALERTS_ESCALATION.md for severity classification."

  notify-on-failure:
    name: notify-on-failure
    runs-on: ubuntu-latest
    needs: uptime-check
    if: ${{ always() && needs.uptime-check.result == 'failure' }}
    steps:
      - name: Force failure and annotate
        run: |
          echo "::error::Uptime Prod workflow failed. Check endpoint status above."
          exit 1
